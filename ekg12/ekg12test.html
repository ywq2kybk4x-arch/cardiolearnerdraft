<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>12-Lead ECG Test Harness</title>
  <style>
    .ecg-shell {
      background: #f9fafb;
      border-top: 2px solid #e5e7eb;
      padding: 20px 24px 28px;
      font-family: Arial, sans-serif;
    }
    .ecg-shell h2 { margin-bottom: 10px; color: #1f2933; }
    .ecg-shell p { color: #4b5563; margin-bottom: 18px; }

    .ecg-grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      align-items: start;
    }

    .ecg-controls {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 16px;
      display: grid;
      gap: 12px;
    }

    .ecg-section {
      border: 1px solid #eef2f7;
      border-radius: 14px;
      padding: 12px;
      background: #fff;
      display: grid;
      gap: 10px;
    }

    .ecg-section-title {
      font-size: 13px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #64748b;
    }

    .ecg-control label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 6px;
    }

    .ecg-control small { color: #6b7280; font-weight: 500; }

    .ecg-control input[type="number"],
    .ecg-control select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
    }

    .ecg-control input[type="number"] {
      appearance: textfield;
      -moz-appearance: textfield;
    }

    .ecg-control input[type="number"]::-webkit-outer-spin-button,
    .ecg-control input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .ecg-field {
      display: grid;
      gap: 6px;
    }

    .ecg-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 4px 0;
    }

    .ecg-row-left {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: #0f172a;
    }

    .ecg-row-left input[type="checkbox"] {
      width: 16px;
      height: 16px;
      margin: 0;
    }

    .ecg-hint {
      font-size: 12px;
      color: #6b7280;
      white-space: nowrap;
      text-align: right;
    }

    .ecg-buttons {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }

    .ecg-buttons button {
      flex: 1;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #fff;
      font-weight: 700;
      cursor: pointer;
      height: 40px;
      transition: background 0.15s ease, border-color 0.15s ease;
    }

    .ecg-buttons button:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }

    .ecg-measure-hint {
      font-size: 12px;
      color: #4b5563;
      margin-top: 6px;
      display: none;
      line-height: 1.25;
    }

    .ecg-measure-hint.active {
      display: block;
    }

    .ecg-help {
      font-size: 12px;
      color: #6b7280;
      line-height: 1.25;
    }

    .ecg-ref {
      margin-left: 8px;
      font-weight: 500;
      font-size: 12px;
      color: #6b7280;
      white-space: nowrap;
    }

    .ecg-display {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 14px;
      display: grid;
      gap: 18px;
    }

    .ecg-canvas-wrap {
      position: relative;
      width: 100%;
      height: 320px;
      border-radius: 10px;
      overflow-x: auto;
      overflow-y: hidden;
      border: 1px solid #e5e7eb;
      background: #fff;
    }

    .ecg-expanded-wrap {
      height: 220px;
    }

    #ecg12Background, #ecg12Trace, #ecg12Overlay,
    #ecg12BigBackground, #ecg12BigTrace, #ecg12BigOverlay {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      display: block;
    }

    #ecg12Overlay, #ecg12BigOverlay {
      z-index: 10;
      pointer-events: none;
    }

    .ecg-expanded-header {
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 6px;
    }

    @media (max-width: 900px) {
      .ecg-grid { grid-template-columns: 1fr; }
      .ecg-canvas-wrap { height: 280px; }
      .ecg-expanded-wrap { height: 220px; }
    }
  </style>
</head>
<body>
  <div class="ecg-shell">
    <h2>12-Lead ECG Prototype (Sinus)</h2>
    <p>MVP harness for a 12-lead layout using the existing single-lead engine.</p>

    <div class="ecg-grid">
      <div class="ecg-controls">
        <div class="ecg-section">
          <div class="ecg-section-title">Rhythm</div>
          <div class="ecg-field">
            <label for="ecg12RhythmPreset">Rhythm preset</label>
            <select id="ecg12RhythmPreset">
              <option value="sinus" selected>Sinus Rhythm</option>
            </select>
          </div>
          <div class="ecg-field">
            <label for="ecg12HeartRate">Heart rate <small>(bpm)</small></label>
            <input id="ecg12HeartRate" type="number" min="40" max="180" value="75" />
          </div>
        </div>

        <div class="ecg-section">
          <div class="ecg-section-title">Axis</div>
          <div class="ecg-field">
            <label for="ecg12AxisMode">Axis mode</label>
            <select id="ecg12AxisMode">
              <option value="normal" selected>Normal Axis (0° to +90°)</option>
              <option value="lad">Left Axis Deviation (0° to −90°)</option>
              <option value="rad">Right Axis Deviation (+90° to +180°)</option>
              <option value="extreme">Extreme Axis (−90° to −180°)</option>
            </select>
          </div>
          <div class="ecg-field" style="gap:8px;">
            <div style="display:flex; gap:8px;">
              <select id="ecg12LeadISign" style="flex:1;">
                <option value="pos" selected>Lead I: Positive</option>
                <option value="neg">Lead I: Negative</option>
              </select>
              <select id="ecg12LeadAVFSign" style="flex:1;">
                <option value="pos" selected>aVF: Positive</option>
                <option value="neg">aVF: Negative</option>
              </select>
            </div>
            <div class="ecg-help">Quadrant method: choose Lead I and aVF polarity; simulator picks axis category.</div>
          </div>
        </div>

        <div class="ecg-section">
          <div class="ecg-section-title">Wave highlights</div>
          <div class="ecg-row">
            <div class="ecg-row-left">
              <input type="checkbox" id="ecg12HighlightP" />
              <span>P wave</span>
            </div>
            <div class="ecg-hint"></div>
          </div>
          <div class="ecg-row">
            <div class="ecg-row-left">
              <input type="checkbox" id="ecg12HighlightQRS" />
              <span>QRS</span>
            </div>
            <div class="ecg-hint"></div>
          </div>
          <div class="ecg-row">
            <div class="ecg-row-left">
              <input type="checkbox" id="ecg12HighlightT" />
              <span>T wave</span>
            </div>
            <div class="ecg-hint"></div>
          </div>
        </div>

        <div class="ecg-section">
          <div class="ecg-section-title">Intervals &amp; tools</div>
          <div class="ecg-row">
            <div class="ecg-row-left">
              <input type="checkbox" id="ecg12HighlightPR" />
              <span>PR interval</span>
            </div>
            <div class="ecg-hint">Normal: 120–200 ms</div>
          </div>
          <div class="ecg-row">
            <div class="ecg-row-left">
              <input type="checkbox" id="ecg12HighlightQRSDur" />
              <span>QRS duration</span>
            </div>
            <div class="ecg-hint">Normal: &lt;120 ms</div>
          </div>
          <div class="ecg-row">
            <div class="ecg-row-left">
              <input type="checkbox" id="ecg12HighlightRR" />
              <span>R–R interval</span>
            </div>
            <div class="ecg-hint">Normal: 600–1000 ms</div>
          </div>
          <div class="ecg-row">
            <div class="ecg-row-left">
              <input type="checkbox" id="ecg12HighlightQT" />
              <span>QT interval</span>
            </div>
            <div class="ecg-hint">Normal: ~350–440 ms</div>
          </div>
          <div class="ecg-row" style="padding-bottom:0;">
            <div class="ecg-row-left">
              <input type="checkbox" id="ecg12MeasureTool" />
              <span>Click &amp; Measure</span>
            </div>
            <div class="ecg-hint"></div>
          </div>
          <div id="ecg12MeasureHint" class="ecg-measure-hint">
            Click to set start/end.<br />
            Drag to measure.<br />
            Hold Shift to keep previous measurements.<br />
            Double-click a measurement to remove it.
          </div>
        </div>

        <div class="ecg-buttons">
          <button id="ecg12Play">Play</button>
          <button id="ecg12Pause">Pause</button>
          <button id="ecg12Reset">Reset</button>
        </div>
      </div>

      <div class="ecg-display">
        <div class="ecg-canvas-wrap" id="ecg12GridWrap">
          <canvas id="ecg12Background"></canvas>
          <canvas id="ecg12Trace"></canvas>
          <canvas id="ecg12Overlay"></canvas>
        </div>

        <div>
          <div class="ecg-expanded-header">
            Expanded Lead: <span id="ecg12ActiveLead">Lead II</span>
          </div>
          <div class="ecg-canvas-wrap ecg-expanded-wrap">
            <canvas id="ecg12BigBackground"></canvas>
            <canvas id="ecg12BigTrace"></canvas>
            <canvas id="ecg12BigOverlay"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="./assets/ekg12simulator.js"></script>
  <script>
    function initEcg12Simulator() {
      const bg = document.getElementById('ecg12Background');
      const trace = document.getElementById('ecg12Trace');
      const overlay = document.getElementById('ecg12Overlay');
      const bigBg = document.getElementById('ecg12BigBackground');
      const bigTrace = document.getElementById('ecg12BigTrace');
      const bigOverlay = document.getElementById('ecg12BigOverlay');

      if (!bg || !trace || !overlay || typeof Ecg12Simulator === 'undefined') return;
      if (window.ecg12SimInstance) return;

      const sim = new Ecg12Simulator(
        {
          backgroundCanvas: bg,
          traceCanvas: trace,
          overlayCanvas: overlay,
          bigBackgroundCanvas: bigBg,
          bigTraceCanvas: bigTrace,
          bigOverlayCanvas: bigOverlay
        },
        { displayTime: 10, heartRate: 75 }
      );
      window.ecg12SimInstance = sim;

      const gridWrap = document.getElementById('ecg12GridWrap');
      if (gridWrap) {
        gridWrap.addEventListener('scroll', () => sim.drawReadoutOverlay());
      }

      const heartRateInput = document.getElementById('ecg12HeartRate');
      const axisModeSelect = document.getElementById('ecg12AxisMode');
      const leadISignSelect = document.getElementById('ecg12LeadISign');
      const leadAVFSignSelect = document.getElementById('ecg12LeadAVFSign');
      const rhythmSelect = document.getElementById('ecg12RhythmPreset');
      const highlightIds = [
        ['ecg12HighlightP', 'P'],
        ['ecg12HighlightQRS', 'QRS'],
        ['ecg12HighlightT', 'T']
      ];
      const intervalHighlightIds = [
        ['ecg12HighlightPR', 'PR'],
        ['ecg12HighlightQRSDur', 'QRSd'],
        ['ecg12HighlightQT', 'QT'],
        ['ecg12HighlightRR', 'RR']
      ];
      const measureToggle = document.getElementById('ecg12MeasureTool');
      const measureHint = document.getElementById('ecg12MeasureHint');
      const playBtn = document.getElementById('ecg12Play');
      const pauseBtn = document.getElementById('ecg12Pause');
      const resetBtn = document.getElementById('ecg12Reset');
      const expandedLabel = document.getElementById('ecg12ActiveLead');

      const clampNumber = (val, min, max) => Math.min(Math.max(val, min), max);

      const updateExpandedLabel = () => {
        if (expandedLabel) expandedLabel.textContent = sim.getSelectedLead();
      };

      const commitHeartRate = () => {
        if (!heartRateInput) return;
        const clampRange = typeof sim.getHeartRateClamp === 'function'
          ? sim.getHeartRateClamp()
          : { min: 40, max: 180 };
        const raw = parseInt(heartRateInput.value || String(sim.getHeartRate ? sim.getHeartRate() : 75), 10);
        const fallback = Number.isNaN(raw) ? (sim.getHeartRate ? sim.getHeartRate() : clampRange.min) : raw;
        const target = clampNumber(fallback, clampRange.min, clampRange.max);
        const applied = sim.setHeartRate ? sim.setHeartRate(target) : target;
        heartRateInput.value = applied;
      };

      const syncHeartRateInput = () => {
        if (!heartRateInput) return;
        const clampRange = typeof sim.getHeartRateClamp === 'function'
          ? sim.getHeartRateClamp()
          : { min: 40, max: 180 };
        heartRateInput.min = clampRange.min;
        heartRateInput.max = clampRange.max;
        const hr = sim.getHeartRate ? sim.getHeartRate() : clampNumber(75, clampRange.min, clampRange.max);
        heartRateInput.value = hr;
      };

      if (heartRateInput) {
        heartRateInput.addEventListener('change', commitHeartRate);
        heartRateInput.addEventListener('blur', commitHeartRate);
      }

      const axisModeToQuadrant = {
        normal: { leadI: 'pos', avf: 'pos' },
        lad: { leadI: 'pos', avf: 'neg' },
        rad: { leadI: 'neg', avf: 'pos' },
        extreme: { leadI: 'neg', avf: 'neg' }
      };

      const quadrantToAxisMode = (leadISign, avfSign) => {
        if (leadISign === 'pos' && avfSign === 'pos') return 'normal';
        if (leadISign === 'pos' && avfSign === 'neg') return 'lad';
        if (leadISign === 'neg' && avfSign === 'pos') return 'rad';
        return 'extreme';
      };

      let syncingAxisControls = false;

      const syncQuadrantFromMode = (mode) => {
        const mapping = axisModeToQuadrant[mode] || axisModeToQuadrant.normal;
        syncingAxisControls = true;
        if (leadISignSelect) leadISignSelect.value = mapping.leadI;
        if (leadAVFSignSelect) leadAVFSignSelect.value = mapping.avf;
        syncingAxisControls = false;
      };

      const applyAxisMode = (mode) => {
        const normalized = axisModeToQuadrant[mode] ? mode : 'normal';
        if (axisModeSelect) axisModeSelect.value = normalized;
        sim.setAxisMode(normalized);
        syncQuadrantFromMode(normalized);
      };

      if (axisModeSelect) {
        axisModeSelect.addEventListener('change', () => applyAxisMode(axisModeSelect.value));
      }

      const handleQuadrantChange = () => {
        if (syncingAxisControls) return;
        const leadISign = leadISignSelect ? leadISignSelect.value : 'pos';
        const avfSign = leadAVFSignSelect ? leadAVFSignSelect.value : 'pos';
        const mode = quadrantToAxisMode(leadISign, avfSign);
        if (axisModeSelect) axisModeSelect.value = mode;
        sim.setAxisMode(mode);
      };

      if (leadISignSelect) leadISignSelect.addEventListener('change', handleQuadrantChange);
      if (leadAVFSignSelect) leadAVFSignSelect.addEventListener('change', handleQuadrantChange);

      const handleRhythmChange = () => {
        if (!rhythmSelect) return;
        const desired = rhythmSelect.value;
        if (typeof sim.setRhythm === 'function') {
          sim.setRhythm(desired);
          const current = sim.getCurrentRhythm ? sim.getCurrentRhythm() : desired;
          rhythmSelect.value = current;
          syncHeartRateInput();
        }
      };

      const populateRhythmOptions = () => {
        if (!rhythmSelect || typeof sim.getRhythmList !== 'function') return;
        const rhythms = sim.getRhythmList();
        if (rhythms && rhythms.length) {
          rhythmSelect.innerHTML = '';
          rhythms.forEach(({ id, label }) => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = label;
            rhythmSelect.appendChild(option);
          });
        }
        const current = sim.getCurrentRhythm ? sim.getCurrentRhythm() : null;
        if (current) rhythmSelect.value = current;
        rhythmSelect.addEventListener('change', handleRhythmChange);
      };

      const updateHighlights = () => {
        const highlightState = {};
        highlightIds.forEach(([id, key]) => {
          const el = document.getElementById(id);
          highlightState[key] = !!(el && el.checked);
        });
        sim.setHighlights(highlightState);

        const intervalState = {};
        intervalHighlightIds.forEach(([id, key]) => {
          const el = document.getElementById(id);
          intervalState[key] = !!(el && el.checked);
        });
        sim.setIntervalHighlights(intervalState);

        if (measureToggle) {
          const enabled = !!measureToggle.checked;
          if (measureHint) {
            measureHint.classList.toggle('active', enabled);
          }
          if (typeof sim.setMeasureToolEnabled === 'function') {
            sim.setMeasureToolEnabled(enabled);
          }
        }
      };

      [...highlightIds, ...intervalHighlightIds].forEach(([id]) => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', updateHighlights);
      });
      if (measureToggle) measureToggle.addEventListener('change', updateHighlights);

      if (playBtn) playBtn.addEventListener('click', () => sim.play());
      if (pauseBtn) pauseBtn.addEventListener('click', () => sim.pause());
      if (resetBtn) resetBtn.addEventListener('click', () => sim.reset());

      trace.addEventListener('click', (event) => {
        const lead = sim.getLeadAtEvent(event);
        if (lead) {
          sim.setSelectedLead(lead);
          updateExpandedLabel();
        }
      });

      if (gridWrap) {
        gridWrap.addEventListener('mousemove', (event) => {
          sim.setHoverLead(sim.getLeadAtEvent(event));
        });
      }

      const initialAxisMode = (typeof sim.getAxisMode === 'function') ? sim.getAxisMode() : 'normal';
      applyAxisMode(initialAxisMode);
      populateRhythmOptions();
      syncHeartRateInput();

      sim.setHoverLead(null);
      updateHighlights();
      updateExpandedLabel();
      sim.play();
    }

    document.addEventListener('DOMContentLoaded', initEcg12Simulator);
  </script>
</body>
</html>
